name: $(System.TeamProject)_$(Build.DefinitionName)_$(Build.SourceBranchName)_$(Build.BuildId)

pool:
  vmImage: windows-latest

variables:
  buildConfiguration: Release
  buildPlatform: Any CPU
  repoName: Songhay.Dashboard
  publishedArtifactName: bolero-drop

resources:
- repo: self

steps:
- task: UseDotNet@2
  displayName: use .NET SDK 6.x
  inputs:
    packageType: sdk
    version: 6.x

- powershell: |
    dotnet --info
  displayName: dotnet --info

- task: VSBuild@1
  displayName: NuGet restore
  inputs:
    msbuildArgs: '/t:Restore'
    configuration: $(buildConfiguration)

- task: VSBuild@1
  displayName: build and package Solution
  inputs:
    solution: '**\$(repoName).sln'
    configuration: $(buildConfiguration)
    platform: $(buildPlatform)
    msbuildArgs: '/p:DeployOnBuild=true /p:DeployDefaultTarget=WebPublish /p:WebPublishMethod=Package /p:PackageAsSingleFile=true /p:SkipInvalidConfigurations=true /p:PackageLocation="$(Build.ArtifactStagingDirectory)"'

- task: VSTest@2
  displayName: test Dashboard
  inputs:
    configuration: $(buildConfiguration)
    platform: $(buildPlatform)
    searchFolder: $(System.DefaultWorkingDirectory)
    testSelector: testAssemblies
    testAssemblyVer2: |
      **/*$(repoName)*Tests.dll
      !**/*$(repoName).Activities.Tests.dll
      !**/*$(repoName).Shell.Tests.dll
      !**\obj\**

- powershell: |
    Write-Host "displaying ArtifactStagingDirectory: ``$(Build.ArtifactStagingDirectory)``..."
    Get-ChildItem -Path "$(Build.ArtifactStagingDirectory)"
  displayName: view `$(Build.ArtifactStagingDirectory)`

- task: AzureRmWebAppDeployment@4
  displayName: deploy published artifact [STAGING]
  inputs:
    azureSubscription: 'Songhay System (Subscription scope; songhay-system-resources-free)'
    packageForLinux: $(Build.ArtifactStagingDirectory)/$(repoName).Server.zip
    WebAppName: songhay-system-staging
